import"../chunks/CWj6FrbW.js";import"../chunks/69_IOA4Y.js";import{o as j}from"../chunks/DFFYA4bw.js";import{p as q,a4 as g,f as J,a7 as U,a as Y,a6 as f,Q as R,g as i,c as S,r as T,B as z}from"../chunks/Cz8b3aZ3.js";import{a as k}from"../chunks/BJQCchKY.js";import{i as N}from"../chunks/BddMa5fM.js";import{f as _,a as E}from"../chunks/C2w1fM-E.js";import{s as Q}from"../chunks/srgpLeXS.js";import{e as D}from"../chunks/CiHTc1pK.js";import{i as $}from"../chunks/BXKlKvRW.js";import{W as u,i as X,b as Z,t as ee,a as V,c as te,d as A,e as ae,g as re}from"../chunks/BM8bzlRp.js";import{c as ie}from"../chunks/n2sX3Rjo.js";import"../chunks/CUAbeyJP.js";function ne({error:e,options:n}){var p,s,c;const{publicKey:r}=n;if(!r)throw Error("options was missing required publicKey property");if(e.name==="AbortError"){if(n.signal instanceof AbortSignal)return new u({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:e})}else if(e.name==="ConstraintError"){if(((p=r.authenticatorSelection)==null?void 0:p.requireResidentKey)===!0)return new u({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:e});if(n.mediation==="conditional"&&((s=r.authenticatorSelection)==null?void 0:s.userVerification)==="required")return new u({message:"User verification was required during automatic registration but it could not be performed",code:"ERROR_AUTO_REGISTER_USER_VERIFICATION_FAILURE",cause:e});if(((c=r.authenticatorSelection)==null?void 0:c.userVerification)==="required")return new u({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:e})}else{if(e.name==="InvalidStateError")return new u({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:e});if(e.name==="NotAllowedError")return new u({message:e.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:e});if(e.name==="NotSupportedError")return r.pubKeyCredParams.filter(m=>m.type==="public-key").length===0?new u({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:e}):new u({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:e});if(e.name==="SecurityError"){const h=globalThis.location.hostname;if(X(h)){if(r.rp.id!==h)return new u({message:`The RP ID "${r.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:e})}else return new u({message:`${globalThis.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:e})}else if(e.name==="TypeError"){if(r.user.id.byteLength<1||r.user.id.byteLength>64)return new u({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:e})}else if(e.name==="UnknownError")return new u({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:e})}return e}async function oe(e){var b;!e.optionsJSON&&e.challenge&&(console.warn("startRegistration() was not called correctly. It will try to continue with the provided options, but this call should be refactored to use the expected call structure instead. See https://simplewebauthn.dev/docs/packages/browser#typeerror-cannot-read-properties-of-undefined-reading-challenge for more information."),e={optionsJSON:e});const{optionsJSON:n,useAutoRegister:r=!1}=e;if(!Z())throw new Error("WebAuthn is not supported in this browser");const p={...n,challenge:V(n.challenge),user:{...n.user,id:V(n.user.id)},excludeCredentials:(b=n.excludeCredentials)==null?void 0:b.map(ee)},s={};r&&(s.mediation="conditional"),s.publicKey=p,s.signal=te.createNewAbortSignal();let c;try{c=await navigator.credentials.create(s)}catch(o){throw ne({error:o,options:s})}if(!c)throw new Error("Registration was not completed");const{id:h,rawId:m,response:l,type:I}=c;let v;typeof l.getTransports=="function"&&(v=l.getTransports());let y;if(typeof l.getPublicKeyAlgorithm=="function")try{y=l.getPublicKeyAlgorithm()}catch(o){C("getPublicKeyAlgorithm()",o)}let w;if(typeof l.getPublicKey=="function")try{const o=l.getPublicKey();o!==null&&(w=A(o))}catch(o){C("getPublicKey()",o)}let O;if(typeof l.getAuthenticatorData=="function")try{O=A(l.getAuthenticatorData())}catch(o){C("getAuthenticatorData()",o)}return{id:h,rawId:A(m),response:{attestationObject:A(l.attestationObject),clientDataJSON:A(l.clientDataJSON),transports:v,publicKeyAlgorithm:y,publicKey:w,authenticatorData:O},type:I,clientExtensionResults:c.getClientExtensionResults(),authenticatorAttachment:ae(c.authenticatorAttachment)}}function C(e,n){console.warn(`The browser extension that intercepted this WebAuthn API call incorrectly implemented ${e}. You should report this error to them.
`,n)}var se=_('<p class="text-red-500"> </p>'),ce=_('<button class="btn btn-primary mt-2">Upload</button>'),le=_('<p class="text-green-600">Registered ✅</p>'),ue=_('<button class="btn btn-secondary"> </button>'),de=_('<h1 class="text-2xl font-bold mb-6">Account Settings</h1> <!> <section class="mb-6"><h2 class="text-xl font-semibold mb-2">Profile Picture</h2> <img alt="Profile" class="w-24 h-24 rounded-full mb-2 object-cover border"/> <input type="file" accept="image/*"/> <!></section> <section class="mb-6"><h2 class="text-xl font-semibold mb-2">WebAuthn Security Key</h2> <!></section>',1);function Oe(e,n){q(n,!1);let r=R(null),p=R(null),s=R(null),c=R(!1),h=R(!1),m=R(null);j(async()=>{var t;try{f(r,await re(fetch)),ie.set(i(r)),f(c,((t=i(r))==null?void 0:t.has_webauthn)??!1)}catch{f(m,"Failed to load user")}});async function l(){if(!i(p))return;const t=new FormData;t.append("avatar",i(p));try{await fetch("/api/user/avatar",{method:"POST",body:t}),location.reload()}catch{f(m,"Upload failed")}}async function I(){var t;f(h,!0),f(m,null);try{if(!((t=i(r))!=null&&t.id))throw new Error("User ID is missing");console.log("🟡 Starting WebAuthn registration for user:",i(r).id);const a=await fetch("/api/auth/webauthn/register/begin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:i(r).id})});if(!a.ok){const P=await a.text();throw console.error("❌ Failed to begin registration:",P),new Error("Failed to begin WebAuthn registration")}const{publicKey:d}=await a.json();if(console.log("🛠️ Received registration options:",d),!d||!d.challenge)throw new Error("Invalid WebAuthn registration options: missing challenge");const L=await oe(d);console.log("✅ Got registration credential:",L);const W=await fetch("/api/auth/webauthn/register/finish",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(L)});if(!W.ok){const P=await W.text();throw console.error("❌ Registration finalization failed:",P),new Error("WebAuthn registration failed")}console.log("🎉 WebAuthn registration complete"),f(c,!0)}catch(a){console.error("❌ setupWebAuthn failed:",a),f(m,a.message)}finally{f(h,!1)}}function v(t){var d;const a=t.target;(d=a==null?void 0:a.files)!=null&&d[0]&&(f(p,a.files[0]),f(s,URL.createObjectURL(i(p))))}$();var y=de(),w=g(J(y),2);{var O=t=>{var a=se(),d=S(a,!0);T(a),U(()=>k(d,i(m))),E(t,a)};N(w,t=>{i(m)&&t(O)})}var b=g(w,2),o=g(S(b),2),K=g(o,2),G=g(K,2);{var M=t=>{var a=ce();D("click",a,l),E(t,a)};N(G,t=>{i(p)&&t(M)})}T(b);var x=g(b,2),B=g(S(x),2);{var F=t=>{var a=le();E(t,a)},H=t=>{var a=ue(),d=S(a,!0);T(a),U(()=>{a.disabled=i(h),k(d,i(h)?"Setting up...":"Register Security Key")}),D("click",a,I),E(t,a)};N(B,t=>{i(c)?t(F):t(H,!1)})}T(x),U(()=>Q(o,"src",(i(s),i(r),z(()=>{var t;return i(s)||((t=i(r))==null?void 0:t.avatar_url)||"/default-avatar.png"})))),D("change",K,v),E(e,y),Y()}export{Oe as component};
